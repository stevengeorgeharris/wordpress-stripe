/*! WP Simple Pay Pro for Stripe - 2.4.3
 * https://wpsimplepay.com/
 * Copyright (c) Moonstone Media 2016
 * Licensed GPLv2+ */

var spApp={};!function(a){"use strict";var b=a(document.body);spApp={spFormElList:{},spFormData:{},init:function(){this.debugLog("spApp.init",this),this.debugLog("simplePayFrontendGlobals",simplePayFrontendGlobals),this.debugLog("simplePayFormSettings",simplePayFormSettings),this.spFormElList=b.find(".sc-checkout-form"),this.spFormElList.each(function(){var b=a(this);spApp.processForm(b),spApp.setupValidation(b),b.find(".sc-uea-custom-amount:first").trigger("change.spUserEnteredAmount"),b.find(".sc-cf-quantity:first").trigger("change.spQuantity"),b.find(".sc-cf-amount:first").trigger("change.spSelectAmount");var c=b.find(".sc-payment-btn");c.prop("disabled",!1).data("textOriginal",c.find("span").text())}),this.initCustomFields(),b.trigger("spBaseInitComplete")},processForm:function(b){function c(c,d){b.find(".sc_stripeToken").val(c.id),b.find(".sc_stripeEmail").val(c.email),a.isEmptyObject(d)||(b.find(".sc-shipping-name").val(d.shipping_name),b.find(".sc-shipping-country").val(d.shipping_address_country),b.find(".sc-shipping-zip").val(d.shipping_address_zip),b.find(".sc-shipping-state").val(d.shipping_address_state),b.find(".sc-shipping-address").val(d.shipping_address_line1),b.find(".sc-shipping-city").val(d.shipping_address_city)),b.find(".sc-payment-btn").prop("disabled",!0).find("span").text(simplePayFrontendGlobals.paymentSubmittingButtonLabel),b.unbind("submit"),b.submit()}var d=b.data("sc-id"),e=simplePayFormSettings[d],f=e.amount||0;this.spFormData[d]={stripeKey:e.key,storeName:this.neg1toNull(e.name),itemDescription:this.neg1toNull(e.description),storeImageUrl:this.neg1toNull(e.image),locale:this.neg1toNull(e.locale),currency:this.neg1toNull(e.currency),checkoutButtonLabel:this.neg1toNull(e.panelLabel),couponCode:"",enableRememberMe:this.neg1toNull(e.allowRememberMe),enableBilling:this.neg1toNull(e.billingAddress),enableShipping:this.neg1toNull(e.shippingAddress),enableVerifyZip:this.neg1toNull(e.zipCode),enableBitcoin:this.neg1toNull(e.bitcoin),enableAlipay:this.neg1toNull(e.alipay),enableAlipayReusable:this.neg1toNull(e.alipayReusable),enablePrefillEmail:this.neg1toNull(e.email),formClientId:b.prop("id"),enableTestMode:this.neg1toNull(e.testMode),zeroAmountCheckoutButtonLabel:simplePayFrontendGlobals.zeroAmountCheckoutButtonLabel,totalAmount:f,baseAmount:f,itemQuantity:1,discountedAmount:f,userEnteredAmount:0,addOnTotalAmountOperand:0};var g=this.spFormData[d],h=StripeCheckout.configure({token:c,opened:function(){},closed:function(){}});b.find(".sc-payment-btn").on("click.spPaymentBtn",function(a){a.preventDefault(),b.trigger("spBeforeStripePayment",[b,g]),spApp.execStripePayment(b,g,h)}),b.find(".sc-uea-custom-amount").on("keyup.spUserEnteredAmount change.spUserEnteredAmount",function(a){spApp.processUserEnteredAmount(b,g),spApp.updateTotalAmount(b,g)}),b.find(".sc-coup-apply-btn").on("click.spCouponApply",function(a){a.preventDefault(),spApp.applyCoupon(b,g)}),b.find(".sc-coup-remove-coupon").on("click.spCouponRemove",function(a){a.preventDefault(),spApp.removeCoupon(b,g)}),b.find(".sc-cf-quantity").on("change.spQuantity",function(c){spApp.setItemQuantity(b,g,a(this)),""===g.couponCode.trim()&&spApp.updateTotalAmount(b,g),b.trigger("spQuantityChanged")}),b.find(".sc-cf-checkbox").on("change.spCheckbox",function(c){spApp.setCheckboxYesNoValues(b,a(this))}),b.find(".sc-cf-amount").on("change.spSelectAmount",function(c){spApp.setAmountFromUEASelect(b,g,a(this)),""===g.couponCode.trim()&&spApp.updateTotalAmount(b,g)}),b.on("spCouponApplied",function(a){spApp.updateTotalAmount(b,g)}),b.on("spCouponRemoved",function(a){spApp.updateTotalAmount(b,g)}),a(window).on("popstate",function(){h.close()})},execStripePayment:function(a,b,c){if(a.find(".sc_amount").val(b.totalAmount),a.find(".sc-uea-custom-amount").val(b.userEnteredAmount),a.parsley().validate()){var d={key:b.stripeKey,amount:b.totalAmount,name:b.storeName,description:b.itemDescription,image:b.storeImageUrl,locale:b.locale,currency:b.currency,panelLabel:b.totalAmount>0?b.checkoutButtonLabel:b.zeroAmountCheckoutButtonLabel,allowRememberMe:b.enableRememberMe,billingAddress:b.enableBilling,shippingAddress:b.enableShipping,zipCode:b.enableVerifyZip,bitcoin:b.enableBitcoin,alipay:b.enableAlipay,alipayReusable:b.enableAlipayReusable,email:b.enablePrefillEmail};c.open(d)}},processUserEnteredAmount:function(a,b){var c=a.find(".sc-uea-custom-amount"),d=accounting.unformat(c.val());b.baseAmount=this.formatForStripe(d,b.currency);var e=2;this.isZeroDecimalCurrency(b.currency)&&(e=0),b.userEnteredAmount=accounting.toFixed(d,e)},updateTotalAmount:function(a,b){""===b.couponCode.trim()?b.totalAmount=b.baseAmount*b.itemQuantity:b.totalAmount=b.discountedAmount,b.totalAmount+=b.addOnTotalAmountOperand;var c=a.find(".sc-total-amount");if(c.length>0){var d=this.unformatFromStripe(b.totalAmount,b.currency);c.text(this.formatCurrency(d,b.currency))}},applyCoupon:function(b,c){var d=b.find(".sc-coup-coupon"),e="",f=b.find(".sc-coup-coupon-applied"),g=b.find(".sc-coup-validation-message"),h=b.find(".sc-coup-success-message"),i=b.find(".sc-coup-loading"),j=b.find(".sc-coup-remove-coupon");if(d.length>0&&(e=d.val().trim()),""===e){if(""===c.couponCode.trim())return;e=c.couponCode}b.trigger("spCouponApplyStart"),c.discountedAmount=c.baseAmount*c.itemQuantity,g.empty(),h.empty(),i.show();var k={action:"scp_get_coupon",coupon:e,amount:c.discountedAmount,test_mode:c.enableTestMode};a.post(simplePayFrontendGlobals.ajaxurl,k,function(a){if(a.success){spApp.removeCoupon(b,c),c.discountedAmount=a.message,c.couponCode=a.coupon.code,f.val(c.couponCode),d.val("");var e=c.couponCode+": ";if("percent"===a.coupon.type)e+=a.coupon.amountOff+"% "+simplePayFrontendGlobals.couponAmountOffText;else if("amount"===a.coupon.type){var k=spApp.unformatFromStripe(a.coupon.amountOff,c.currency);e+=spApp.formatCurrency(k,c.currency)+" "+simplePayFrontendGlobals.couponAmountOffText}h.text(e),j.show(),b.trigger("spCouponApplied")}else g.text(a.message);i.hide()},"json")},removeCoupon:function(a,b){var c=a.find(".sc-coup-coupon-applied"),d=a.find(".sc-coup-validation-message"),e=a.find(".sc-coup-success-message"),f=a.find(".sc-coup-remove-coupon");b.discountedAmount=b.baseAmount*b.itemQuantity,b.couponCode="",c.val(""),d.empty(),e.empty(),f.hide(),a.trigger("spCouponRemoved")},setItemQuantity:function(a,b,c){var d=1;c.length>0&&(d=c.is('input[type="radio"]')?parseInt(c.filter(":checked").val().trim()):parseInt(c.val().trim())),b.itemQuantity=d,this.applyCoupon(a,b)},initCustomFields:function(){b.find(".sc-cf-date").pikaday({format:"M/D/YYYY"})},setCheckboxYesNoValues:function(a,b){var c=b.prop("id"),d=a.find("#"+c+"_hidden");d.val(b.is(":checked")?"Yes":"No")},setAmountFromUEASelect:function(a,b,c){if(c.length>0){var d=0;d=c.is('input[type="radio"]')?accounting.unformat(c.filter(":checked").data("sc-price")):accounting.unformat(c.find("option:selected").data("sc-price")),b.baseAmount=d,this.applyCoupon(a,b)}},setupValidation:function(a){a.parsley({errorsContainer:function(a){return a.closest(".sc-form-group")}})},debugLog:function(a,b){"undefined"!=typeof simplePayFrontendGlobals&&"true"===simplePayFrontendGlobals.scriptDebug&&console.log(a,b)},formatForStripe:function(a,b){return this.isZeroDecimalCurrency(b)?Math.round(a):Math.round(parseFloat(100*a))},unformatFromStripe:function(a,b){return this.isZeroDecimalCurrency(b)?Math.round(a):(a/100).toFixed(2)},isZeroDecimalCurrency:function(b){try{return a.inArray(b.toUpperCase(),simplePayFrontendGlobals.zeroDecimalCurrencies)>1}catch(c){return!1}},formatCurrency:function(a,b){try{b=b.toUpperCase();var c={};return"USD"!==b&&(c.symbol=b,c.format="%v %s"),this.isZeroDecimalCurrency(b)&&(c.precision=0),accounting.formatMoney(a,c)}catch(d){return a}},neg1toNull:function(a){return-1===parseInt(a)&&(a=null),a}},a(document).ready(function(a){spApp.init(),spApp.debugLog("spApp.spFormData",spApp.spFormData)}),a(window).on("beforeunload",function(){this.spFormElList=b.find(".sc-checkout-form"),this.spFormElList.each(function(){var b=a(this).find(".sc-payment-btn");b.prop("disabled",!1).find("span").text(b.data("textOriginal"))})})}(jQuery);